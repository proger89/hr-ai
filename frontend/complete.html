<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Результаты интервью</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <style>
      :root{--accent:#3b5bdb;--bg:#0f0f1e;--text:#ffffff;--success:#10b981;--warning:#f59e0b;--danger:#ef4444}
      *{box-sizing:border-box}
      body{font-family:system-ui,-apple-system,sans-serif;margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;flex-direction:column}
      
      .bg-grad{
        background: radial-gradient(ellipse at center, #1a1a3e 0%, #0f0f1e 100%);
        position: fixed;
        inset: 0;
        z-index: -1;
      }
      
      .container{
        max-width:800px;
        margin:0 auto;
        padding:40px 20px;
      }
      
      .result-card{
        background:rgba(255,255,255,0.05);
        border:1px solid rgba(255,255,255,0.1);
        border-radius:16px;
        padding:40px;
        backdrop-filter:blur(10px);
        box-shadow:0 8px 32px rgba(0,0,0,0.2);
      }
      
      .score-circle{
        width:200px;
        height:200px;
        margin:0 auto 30px;
        position:relative;
      }
      
      .score-value{
        position:absolute;
        top:50%;
        left:50%;
        transform:translate(-50%,-50%);
        font-size:48px;
        font-weight:700;
      }
      
      .score-label{
        position:absolute;
        top:65%;
        left:50%;
        transform:translateX(-50%);
        font-size:14px;
        opacity:0.7;
      }
      
      .decision-badge{
        display:inline-block;
        padding:8px 24px;
        border-radius:20px;
        font-weight:500;
        margin:20px 0;
      }
      
      .decision-hired{
        background:var(--success);
        color:var(--bg);
      }
      
      .decision-maybe{
        background:var(--warning);
        color:var(--bg);
      }
      
      .decision-rejected{
        background:var(--danger);
        color:white;
      }
      
      .criteria-item{
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:12px 0;
        border-bottom:1px solid rgba(255,255,255,0.1);
      }
      
      .criteria-bar{
        width:200px;
        height:8px;
        background:rgba(255,255,255,0.1);
        border-radius:4px;
        overflow:hidden;
        margin:0 20px;
      }
      
      .criteria-fill{
        height:100%;
        background:var(--accent);
        transition:width 0.5s ease;
      }
      
      .section-title{
        font-size:20px;
        font-weight:600;
        margin:30px 0 20px;
        color:var(--accent);
      }
      
      .list-item{
        padding:8px 0;
        padding-left:20px;
        position:relative;
      }
      
      .list-item:before{
        content:"•";
        position:absolute;
        left:0;
        color:var(--accent);
      }
      
      .report-section{
        background:rgba(255,255,255,0.03);
        border:1px solid rgba(255,255,255,0.08);
        border-radius:8px;
        padding:20px;
        margin:20px 0;
        white-space:pre-wrap;
        font-family:inherit;
        line-height:1.6;
      }
      
      .action-buttons{
        display:flex;
        gap:20px;
        margin-top:40px;
        justify-content:center;
      }
      
      .btn-custom{
        padding:12px 32px;
        border-radius:8px;
        border:none;
        font-weight:500;
        cursor:pointer;
        transition:all 0.3s;
        text-decoration:none;
        display:inline-block;
      }
      
      .btn-primary{
        background:var(--accent);
        color:white;
      }
      
      .btn-primary:hover{
        background:#2f4ac7;
        transform:translateY(-2px);
      }
      
      .btn-secondary{
        background:rgba(255,255,255,0.1);
        color:white;
        border:1px solid rgba(255,255,255,0.2);
      }
      
      .btn-secondary:hover{
        background:rgba(255,255,255,0.2);
      }
      
      .loading{
        text-align:center;
        padding:40px;
        font-size:18px;
        opacity:0.7;
      }
      
      @keyframes fadeIn{
        from{opacity:0;transform:translateY(20px)}
        to{opacity:1;transform:translateY(0)}
      }
      
      .fade-in{
        animation:fadeIn 0.5s ease-out;
      }
    </style>
  </head>
  <body>
    <div class="bg-grad"></div>
    
    <div class="container">
      <div class="result-card fade-in">
        <h1 class="text-center mb-4">Результаты интервью</h1>
        
        <div id="loadingSection" class="loading">
          Загрузка результатов...
        </div>
        
        <div id="resultSection" style="display:none">
          <!-- Круговая диаграмма со счётом -->
          <div class="score-circle">
            <svg width="200" height="200">
              <circle cx="100" cy="100" r="90" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="12"/>
              <circle id="scoreArc" cx="100" cy="100" r="90" fill="none" stroke="var(--accent)" stroke-width="12"
                      stroke-dasharray="565.5" stroke-dashoffset="565.5" 
                      transform="rotate(-90 100 100)" stroke-linecap="round"/>
            </svg>
            <div class="score-value" id="scoreValue">0</div>
            <div class="score-label">из 100</div>
          </div>
          
          <!-- Решение -->
          <div class="text-center">
            <div id="decisionBadge" class="decision-badge"></div>
          </div>
          
          <!-- Детальная оценка по критериям -->
          <div class="section-title">Детальная оценка</div>
          <div id="criteriaSection">
            <div class="criteria-item">
              <span>Опыт работы</span>
              <div class="criteria-bar">
                <div class="criteria-fill" id="experienceBar" style="width:0%"></div>
              </div>
              <span id="experienceScore">0</span>
            </div>
            <div class="criteria-item">
              <span>Технические навыки</span>
              <div class="criteria-bar">
                <div class="criteria-fill" id="stackBar" style="width:0%"></div>
              </div>
              <span id="stackScore">0</span>
            </div>
            <div class="criteria-item">
              <span>Решение задач</span>
              <div class="criteria-bar">
                <div class="criteria-fill" id="casesBar" style="width:0%"></div>
              </div>
              <span id="casesScore">0</span>
            </div>
            <div class="criteria-item">
              <span>Коммуникация</span>
              <div class="criteria-bar">
                <div class="criteria-fill" id="communicationBar" style="width:0%"></div>
            </div>
              <span id="communicationScore">0</span>
          </div>
        </div>
        
          <!-- Сильные стороны -->
          <div class="section-title">Сильные стороны</div>
          <div id="strengthsList"></div>
          
          <!-- Зоны для развития -->
          <div class="section-title">Зоны для развития</div>
          <div id="weaknessesList"></div>
          
          <!-- Детальный отчёт -->
          <div class="section-title">Детальный отчёт</div>
          <div class="report-section" id="detailedReport">
            Загрузка отчёта...
        </div>
        
          <!-- Кнопки действий -->
          <div class="action-buttons">
            <a href="/hr.html" class="btn-custom btn-primary">К списку кандидатов</a>
            <button class="btn-custom btn-secondary" onclick="downloadReport()">Скачать отчёт</button>
          </div>
          </div>
        </div>
      </div>
    
    <script>
      // Получаем параметры из URL
      const params = new URLSearchParams(window.location.search);
      const candidateId = params.get('id') || params.get('candidate_id');
      const score = parseInt(params.get('score')) || 0;
      const decision = params.get('decision') || 'maybe';
      
      // Элементы
      const loadingSection = document.getElementById('loadingSection');
      const resultSection = document.getElementById('resultSection');
      const scoreValue = document.getElementById('scoreValue');
      const scoreArc = document.getElementById('scoreArc');
      const decisionBadge = document.getElementById('decisionBadge');
      const detailedReport = document.getElementById('detailedReport');
      
      // Маппинг решений
      const decisionMap = {
        'hired': { text: 'Рекомендован к найму', class: 'decision-hired' },
        'maybe': { text: 'Требует обсуждения', class: 'decision-maybe' },
        'rejected': { text: 'Не рекомендован', class: 'decision-rejected' }
      };
      
      // Загрузка данных кандидата
      async function loadCandidateData() {
        if (!candidateId) {
          showBasicResults();
          return;
        }
        
        try {
          const response = await fetch(`/api/candidates/${candidateId}`);
          if (!response.ok) throw new Error('Failed to load candidate');
          
          const candidate = await response.json();
          const tags = candidate.tags || {};
          
          // Показываем результаты
          showResults({
            score: tags.interview_score || score,
            decision: tags.interview_decision || decision,
            scoring: tags.interview_scoring || {},
            report: tags.interview_report || '',
            name: candidate.name || 'Кандидат'
          });
          
        } catch (err) {
          console.error('Error loading candidate:', err);
          showBasicResults();
        }
      }
      
      // Показ базовых результатов
      function showBasicResults() {
        showResults({
          score: score,
          decision: decision,
          scoring: {
            scores: {
              experience: Math.round(score * 0.9),
              stack: Math.round(score * 0.95),
              cases: Math.round(score * 1.05),
              communication: Math.round(score * 1.1)
            },
            strengths: ['Мотивированный', 'Коммуникабельный'],
            weaknesses: ['Требует развития технических навыков']
          },
          report: 'Детальный отчёт будет доступен после обработки'
        });
      }
      
      // Показ результатов
      function showResults(data) {
        // Скрываем загрузку
        loadingSection.style.display = 'none';
        resultSection.style.display = 'block';
        
        // Анимация счёта
        animateScore(data.score);
        
        // Решение
        const decisionInfo = decisionMap[data.decision] || decisionMap['maybe'];
        decisionBadge.textContent = decisionInfo.text;
        decisionBadge.className = 'decision-badge ' + decisionInfo.class;
        
        // Критерии оценки
        if (data.scoring.scores) {
          animateCriteria('experience', data.scoring.scores.experience || 0);
          animateCriteria('stack', data.scoring.scores.stack || 0);
          animateCriteria('cases', data.scoring.scores.cases || 0);
          animateCriteria('communication', data.scoring.scores.communication || 0);
        }
        
        // Сильные стороны
        const strengthsList = document.getElementById('strengthsList');
        if (data.scoring.strengths && data.scoring.strengths.length > 0) {
          strengthsList.innerHTML = data.scoring.strengths
            .map(s => `<div class="list-item">${s}</div>`)
            .join('');
        } else {
          strengthsList.innerHTML = '<div class="list-item">Информация будет доступна после анализа</div>';
        }
        
        // Слабые стороны
        const weaknessesList = document.getElementById('weaknessesList');
        if (data.scoring.weaknesses && data.scoring.weaknesses.length > 0) {
          weaknessesList.innerHTML = data.scoring.weaknesses
            .map(w => `<div class="list-item">${w}</div>`)
            .join('');
        } else {
          weaknessesList.innerHTML = '<div class="list-item">Информация будет доступна после анализа</div>';
        }
        
        // Детальный отчёт
        if (data.report) {
          detailedReport.textContent = data.report;
        } else {
          detailedReport.textContent = 'Детальный отчёт генерируется...';
        }
      }
      
      // Анимация счёта
      function animateScore(targetScore) {
        let currentScore = 0;
        const duration = 1500;
        const increment = targetScore / (duration / 16);
        const circumference = 2 * Math.PI * 90;
        
        const animate = () => {
          currentScore += increment;
          if (currentScore >= targetScore) currentScore = targetScore;
          
          scoreValue.textContent = Math.round(currentScore);
          const offset = circumference - (currentScore / 100) * circumference;
          scoreArc.style.strokeDashoffset = offset;
          
          if (currentScore < targetScore) {
            requestAnimationFrame(animate);
          }
        };
        
        requestAnimationFrame(animate);
      }
      
      // Анимация критериев
      function animateCriteria(criterion, score) {
        const bar = document.getElementById(criterion + 'Bar');
        const scoreEl = document.getElementById(criterion + 'Score');
        
          setTimeout(() => {
          bar.style.width = score + '%';
          scoreEl.textContent = score;
        }, 500);
      }
      
      // Скачивание отчёта
      function downloadReport() {
        const report = document.getElementById('detailedReport').textContent;
        const blob = new Blob([report], { type: 'text/plain;charset=utf-8' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `interview_report_${candidateId || 'candidate'}_${new Date().toISOString().split('T')[0]}.txt`;
        a.click();
        window.URL.revokeObjectURL(url);
      }
      
      // Загружаем данные при загрузке страницы
      window.addEventListener('load', loadCandidateData);
    </script>
  </body>
</html>
