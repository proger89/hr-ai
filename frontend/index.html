<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Интервью</title>
    <style>
      :root{--accent:#3b5bdb;--danger:#c0392b;--ok:#2e7d32;--warn:#f59f00;--bg:#f7f8fa;--text:#1f2a37}
      *{box-sizing:border-box}
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif;margin:0;background:var(--bg);color:var(--text)}
      header{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;padding:10px 16px;display:flex;align-items:center;justify-content:space-between}
      .h-left{display:flex;gap:12px;align-items:center}
      .pill{padding:4px 8px;border-radius:999px;background:#eceff5}
      .pill.ok{background:#e7f5ff;color:#1c7ed6}
      .pill.warn{background:#fff3bf;color:#e67700}
      .pill.err{background:#ffe3e3;color:#c92a2a}
      main{max-width:1200px;margin:16px auto;padding:0 16px}
      .grid{display:grid;grid-template-columns:280px 1fr 280px;gap:16px}
      .col{min-width:0}
      .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px}
      .dialog{display:flex;flex-direction:column;gap:8px}
      .msg{display:flex;gap:8px}
      .msg .bubble{padding:8px 10px;border-radius:12px;background:#f1f3f5}
      .msg.assistant .bubble{background:#edf2ff}
      .msg.candidate .bubble{background:#e6fcf5}
      .partial{opacity:.7}
      .avatar{width:64px;height:64px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#5c7cfa,#748ffc);position:relative;overflow:hidden}
      .bars{position:absolute;bottom:4px;left:6px;right:6px;height:24px;display:flex;gap:3px;align-items:flex-end}
      .bars span{flex:1;background:rgba(255,255,255,.8);border-radius:3px;height:20%}
      .bars span:nth-child(odd){height:30%}
      .bars.anim span{animation:vu 600ms ease-in-out infinite alternate}
      .bars.anim span:nth-child(2){animation-delay:80ms}
      .bars.anim span:nth-child(3){animation-delay:160ms}
      .bars.anim span:nth-child(4){animation-delay:240ms}
      .bars.anim span:nth-child(5){animation-delay:320ms}
      @keyframes vu{from{height:15%}to{height:75%}}
      .controls{position:sticky;bottom:0;background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:8px;display:flex;gap:8px;align-items:center;justify-content:space-between;margin-top:12px}
      .row{display:flex;gap:8px;align-items:center}
      button{border:1px solid #cbd5e1;background:#fff;color:#111827;border-radius:8px;padding:8px 12px;cursor:pointer}
      button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
      button[disabled]{opacity:.6;cursor:not-allowed}
      .dangerBtn{background:var(--danger);color:#fff;border:none;padding:8px 12px;border-radius:8px}
      .dangerBtn[disabled]{opacity:.5}
      textarea,input,select{border:1px solid #cbd5e1;border-radius:8px;padding:8px}
      .small{font-size:12px;color:#4b5563}
      .dot{width:10px;height:10px;border-radius:50%;background:#c0392b;display:inline-block}
      .blink{animation:pulse 1.5s infinite}
      @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(192,57,43,.7)}70%{box-shadow:0 0 0 10px rgba(192,57,43,0)}100%{box-shadow:0 0 0 0 rgba(192,57,43,0)}}
      .visually-hidden{position:absolute!important;height:1px;width:1px;overflow:hidden;clip:rect(1px,1px,1px,1px);white-space:nowrap}
      .net-banner{position:sticky;top:52px;margin:8px 0;background:#fff4e6;border:1px solid #ffd8a8;color:#7f5f00;border-radius:10px;padding:8px 12px;display:none;align-items:center;justify-content:space-between;gap:8px}
      .net-banner .actions{display:flex;gap:8px;align-items:center}
      /* Responsive */
      @media (max-width: 600px){
        header{flex-direction:column;align-items:flex-start;gap:8px}
        main{max-width:100%;padding:0 12px}
        .grid{display:block}
        .card{padding:10px}
        .row{flex-wrap:wrap}
        .controls{position:static;margin-top:8px}
        .avatar{width:48px;height:48px}
        .bars{height:18px;left:4px;right:4px}
        .net-banner{top:0}
      }
      @media (min-width: 1024px){
        .grid{grid-template-columns:300px 1fr 300px}
        main{max-width:1200px}
      }
    </style>
  </head>
  <body>
    <header>
      <div class="h-left">
        <strong>Интервью</strong>
        <span id="timer" class="pill">00:00</span>
        <span id="net" class="pill">—</span>
        <span id="ping" class="pill small">ping: —</span>
      </div>
      <div class="row">
        <label>Язык STT
          <select id="lang">
            <option value="ru-RU" selected>ru-RU</option>
            <option value="en-US">en-US</option>
            <option value="auto">auto</option>
          </select>
        </label>
        <span id="langDetected" class="pill small">—</span>
        <button id="btnPause">Пауза</button>
        <button id="btnFinish" class="dangerBtn">Завершить</button>
      </div>
    </header>
    <main>
      <div id="netBanner" class="net-banner" role="alert" aria-live="assertive">
        <span>Связь ухудшилась. Переключиться в чат? Автопереход через <span id="netCountdown">10</span>с.</span>
        <div class="actions">
          <button id="btnStay">Остаться в голосе</button>
          <button id="btnGoChat" class="primary">Переключиться в чат</button>
        </div>
      </div>
      <div class="grid">
        <div class="col card">
          <h3 style="margin:0 0 8px">Диалог</h3>
          <div class="dialog" id="dialog"></div>
          <div id="dlgEmpty" class="empty" style="display:none;margin-top:8px">Пока нет сообщений</div>
        </div>
        <div class="col">
          <div class="card" style="display:flex;gap:12px;align-items:center">
            <div class="avatar" aria-hidden="true">
              <div class="bars anim" id="avatarBars"><span></span><span></span><span></span><span></span><span></span></div>
            </div>
            <div class="grow">
              <div class="small" id="competency">Тема: вводная</div>
              <div style="font-size:18px;font-weight:600" id="question">Расскажите о вашем последнем проекте (1–2 предложения).</div>
            </div>
          </div>

          <div class="controls">
            <div class="row">
              <button id="btnMute">Mute</button>
              <button id="btnRepeat">Повторить вопрос</button>
              <label>Скорость TTS <input type="range" id="rate" min="0.7" max="1.4" step="0.1" value="1" /></label>
              <span id="barge" class="pill" title="Кандидат говорит" style="display:none">говорите вы</span>
            </div>
            <div class="row">
              <button id="btnChat">Перейти в чат</button>
            </div>
          </div>
          <div class="row" id="chatControls" style="gap:8px;align-items:center;display:none;margin-top:8px">
            <input id="chatInput" type="text" placeholder="Ваш ответ..." style="flex:1" />
            <button id="btnChatSend" class="primary">Отправить</button>
          </div>
        </div>
        <div class="col card">
          <h3 style="margin:0 0 8px">Прогресс</h3>
          <div class="row" style="flex-wrap:wrap;gap:6px">
            <span class="pill ok">Тех</span>
            <span class="pill">Комм</span>
            <span class="pill">Кейсы</span>
          </div>
          <div class="small" style="margin-top:8px">Активная тема подсвечена.</div>
        </div>
      </div>
      <div class="small" id="stateWrap" style="margin:8px 0 0 2px">Состояние: <span id="state">слушает: нет</span> <span id="recDot" class="dot" title="Запись"></span></div>
      <audio id="player" hidden></audio>
      <textarea id="ssml" style="display:none"><speak version="1.0" xml:lang="ru-RU"><p>Повторяю вопрос. Расскажите о вашем последнем проекте: цели, ваша роль, результат.</p></speak></textarea>
      <div id="sr" class="visually-hidden" aria-live="polite"></div>
    </main>
    <script>
      // Bootstrap skin
      (function(){ try{ document.querySelectorAll('button').forEach(b=>{ b.classList.add('btn'); if(b.classList.contains('primary')) b.classList.add('btn-primary'); else if(b.classList.contains('dangerBtn')) b.classList.add('btn-danger'); else b.classList.add('btn-outline-secondary'); }); document.querySelectorAll('select').forEach(s=> s.classList.add('form-select')); document.querySelectorAll('input[type="range"]').forEach(r=> r.classList.add('form-range')); }catch{} })();
      // Telemetry
      const Telemetry = {
        emit(name, payload){
          try{
            console.log('[telemetry]', name, payload||{});
            fetch('/api/metrics', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ name, ...(payload||{}) }) });
          }catch{}
        }
      };
      // Elements
      const dialog = document.getElementById('dialog');
      const btnPause = document.getElementById('btnPause');
      const btnFinish = document.getElementById('btnFinish');
      const btnMute = document.getElementById('btnMute');
      const btnRepeat = document.getElementById('btnRepeat');
      const btnChat = document.getElementById('btnChat');
      const chatControls = document.getElementById('chatControls');
      const chatInput = document.getElementById('chatInput');
      const btnChatSend = document.getElementById('btnChatSend');
      const rateEl = document.getElementById('rate');
      const player = document.getElementById('player');
      const ssmlEl = document.getElementById('ssml');
      const langSel = document.getElementById('lang');
      const langDetectedEl = document.getElementById('langDetected');
      const stateEl = document.getElementById('state');
      const recDot = document.getElementById('recDot');
      const bargeBadge = document.getElementById('barge');
      const timerEl = document.getElementById('timer');
      const netEl = document.getElementById('net');
      const pingEl = document.getElementById('ping');
      const avatarBars = document.getElementById('avatarBars');
      const sr = document.getElementById('sr');
      const netBanner = document.getElementById('netBanner');
      const netCountdown = document.getElementById('netCountdown');
      const btnStay = document.getElementById('btnStay');
      const btnGoChat = document.getElementById('btnGoChat');

      let mediaStream, mediaSource, processor, ws;
      let currentReqId = null;
      let paused = false;
      let muted = false;
      let startTs = Date.now();
      let ttsStartMs = 0;
      let lastSendTs = 0;
      let currentSttLang = 'ru-RU';
      let chosenLangMode = 'auto';
      let autoLangLocked = false;

      // Timer
      setInterval(()=>{
        const s = Math.floor((Date.now()-startTs)/1000); const mm=String(Math.floor(s/60)).padStart(2,'0'); const ss=String(s%60).padStart(2,'0');
        timerEl.textContent = `${mm}:${ss}`;
      }, 1000);

      // Ping + net state
      let lastDegraded = false;
      let degradeTimer = null; let remaining = 10;
      async function probe(){
        const t0 = performance.now();
        let ok = false;
        try{ const r = await fetch('/healthz', { cache:'no-store' }); ok = r.ok; }catch{}
        const dt = Math.round(performance.now()-t0);
        pingEl.textContent = `ping: ${ok?dt:'—'}`;
        if(!ok){ netEl.textContent='сеть: оффлайн'; netEl.className='pill err'; }
        else if(dt<120){ netEl.textContent='сеть: ок'; netEl.className='pill ok'; lastDegraded=false; }
        else if(dt<300){ netEl.textContent='сеть: средняя'; netEl.className='pill warn'; lastDegraded=false; hideBanner(); }
        else {
          netEl.textContent='сеть: плохая'; netEl.className='pill err';
          if(!lastDegraded){ Telemetry.emit('network_degraded', { ping_ms: dt }); lastDegraded = true; showBanner(); }
        }
      }
      setInterval(probe, 5000); probe();

      function showBanner(){ try{ clearInterval(degradeTimer); }catch{} remaining = 10; netCountdown.textContent=String(remaining); netBanner.style.display='flex'; degradeTimer = setInterval(()=>{ remaining-=1; netCountdown.textContent=String(remaining); if(remaining<=0){ try{ clearInterval(degradeTimer); }catch{} goChat(); } }, 1000); }
      function hideBanner(){ try{ clearInterval(degradeTimer); }catch{} netBanner.style.display='none'; }
      function goChat(){
        Telemetry.emit('fallback_chat');
        hideBanner();
        try{ stop(); }catch{}
        chatControls.style.display='flex';
        setListen(false);
        stateEl.textContent = 'режим: чат';
      }
      btnGoChat.addEventListener('click', goChat);
      btnStay.addEventListener('click', ()=>{ hideBanner(); lastDegraded=false; });

      function pushAssistant(text){
        const div = document.createElement('div'); div.className='msg assistant';
        div.innerHTML = `<div class="bubble">${text}</div>`; dialog.appendChild(div); dialog.scrollTop = dialog.scrollHeight;
        try{ document.getElementById('dlgEmpty').style.display='none'; }catch{}
      }
      function pushCandidate(text, isPartial=false){
        const div = document.createElement('div'); div.className='msg candidate';
        div.innerHTML = `<div class="bubble ${isPartial?'partial':''}">${text}</div>`; dialog.appendChild(div); dialog.scrollTop = dialog.scrollHeight; return div;
      }

      function setListen(on){ stateEl.textContent = `слушает: ${on ? 'да' : 'нет'}`; if(on){ recDot.classList.add('blink'); } else { recDot.classList.remove('blink'); } }

      function decideLangFromText(text){
        if(!text) return null;
        const hasCyr = /[А-Яа-яЁё]/.test(text);
        const hasLat = /[A-Za-z]/.test(text);
        if(hasCyr && !hasLat) return 'ru-RU';
        if(hasLat && !hasCyr) return 'en-US';
        return null;
      }

      function setLangDetected(lbl){ langDetectedEl.textContent = lbl; }

      function connectStt(lang){
        if(ws){ try{ ws.close(); }catch{} }
        ws = new WebSocket(`ws://${location.host}/ws/stt?lang=${encodeURIComponent(lang)}`);
        ws.binaryType = 'arraybuffer';
        setLangDetected(lang);
        let currentPartialEl = null;
        ws.onopen = () => { setListen(true); };
        ws.onclose = () => { setListen(false); };
        ws.onerror = () => { setListen(false); };
        ws.onmessage = (e) => {
          try{
            const msg = JSON.parse(e.data);
            if(msg.type==='partial'){
              if(!currentPartialEl){ currentPartialEl = pushCandidate('', true); }
              currentPartialEl.querySelector('.bubble').textContent = msg.text || '';
              try{ sr.textContent = 'partial updated'; }catch{}
              Telemetry.emit('stt_partial', { length: (msg.text||'').length });
              if(lastSendTs){ const ms = Math.round(performance.now()-lastSendTs); Telemetry.emit('stt_partial_ms', { ms }); }
              if(chosenLangMode==='auto' && !autoLangLocked){
                const guess = decideLangFromText(msg.text||'');
                if(guess && guess !== currentSttLang){
                  currentSttLang = guess; autoLangLocked = true; setLangDetected(currentSttLang+' (auto)');
                  connectStt(currentSttLang);
                }
              }
            } else if(msg.type==='final'){
              if(currentPartialEl){ currentPartialEl.remove(); currentPartialEl = null; }
              pushCandidate(msg.text || '', false);
              try{ sr.textContent = 'final text'; }catch{}
              Telemetry.emit('stt_final', { length: (msg.text||'').length });
              if(chosenLangMode==='auto' && !autoLangLocked){
                const guessF = decideLangFromText(msg.text||'');
                if(guessF && guessF !== currentSttLang){ currentSttLang = guessF; autoLangLocked = true; setLangDetected(currentSttLang+' (auto)'); connectStt(currentSttLang); }
              }
              // запрос следующего вопроса
              fetch(`/api/dialog/next`, {
                method: 'POST', headers: { 'Content-Type':'application/json' },
                body: JSON.stringify({ last_answer: msg.text||'', lang: currentSttLang })
              }).then(r=>r.json()).then(d=>{
                if(d && d.question){
                  document.getElementById('competency').textContent = 'Тема: ' + (d.competency||'');
                  document.getElementById('question').textContent = d.question;
                }
              }).catch(()=>{});
            }
          }catch{}
        };
      }

      async function start(){
        Telemetry.emit('interview_started');
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: { channelCount: 1, sampleRate: 16000 }, video: false });
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });
        mediaSource = audioCtx.createMediaStreamSource(mediaStream);
        processor = audioCtx.createScriptProcessor(4096, 1, 1);
        mediaSource.connect(processor);
        processor.connect(audioCtx.destination);

        // Language mode init
        try{ langSel.value = 'auto'; }catch{}
        const uiDefault = (navigator.language||'ru').startsWith('ru') ? 'ru-RU' : 'en-US';
        const sel = langSel.value || 'auto';
        chosenLangMode = (sel === 'auto') ? 'auto' : 'fixed';
        currentSttLang = (sel === 'auto') ? uiDefault : sel;
        autoLangLocked = false; setLangDetected((sel==='auto' ? currentSttLang+' (auto)' : currentSttLang));

        connectStt(currentSttLang);

        // RMS + barge-in detector
        let lastAbove = 0;
        processor.onaudioprocess = (ev) => {
          const input = ev.inputBuffer.getChannelData(0);
          // compute RMS fast
          let sum=0; for(let i=0;i<input.length;i++){ const s = input[i]; sum += s*s; }
          const rms = Math.sqrt(sum/input.length);
          const now = performance.now();
          if(rms>0.025){ lastAbove = now; if(currentReqId){ const ms = Math.max(0, Math.round(now - (ttsStartMs||now))); Telemetry.emit('barge_in_ms', { ms, rms }); Telemetry.emit('barge_in', { rms }); showBarge(true); stopTts(); } }

          if(!ws || ws.readyState !== 1 || paused || muted) return;
          const pcm16 = new Int16Array(input.length);
          for(let i=0;i<input.length;i++){
            const s = Math.max(-1, Math.min(1, input[i]));
            pcm16[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
          }
          lastSendTs = performance.now();
          ws.send(pcm16.buffer);
        };
      }

      function stop(){
        try{ if(ws) ws.close(); }catch{}
        try{ if(processor){ processor.disconnect(); processor.onaudioprocess=null; } }catch{}
        try{ if(mediaSource) mediaSource.disconnect(); }catch{}
        try{ mediaStream?.getTracks().forEach(t=>t.stop()); }catch{}
        setListen(false);
      }

      function showBarge(on){ bargeBadge.style.display = on ? 'inline-block' : 'none'; if(on){ avatarBars.classList.remove('anim'); } else { avatarBars.classList.add('anim'); } }

      async function speakQuestion(){
        const rate = Number(rateEl.value)||1; const lang = (langSel.value||'ru-RU').startsWith('ru')?'ru-RU':'en-US';
        const ssml = ssmlEl.value.replace(/xml:lang=\".*?\"/, `xml:lang=\"${lang}\"`).replace('<prosody','<prosody rate="'+Math.round(rate*100)+'%"');
        const reqId = 'req-'+Date.now();
        currentReqId = reqId; showBarge(false);
        ttsStartMs = performance.now();
        const res = await fetch(`/api/tts/synthesize/stream?request_id=${encodeURIComponent(currentReqId)}&voice=Nec_24000&sample_rate=24000&ssml=${encodeURIComponent(ssml)}`, { method:'POST' });
        if(!res.ok){ if(currentReqId===reqId) currentReqId=null; return; }
        const reader = res.body.getReader(); let first=true;
        const supportsMSE = !!(window.MediaSource && MediaSource.isTypeSupported && (MediaSource.isTypeSupported('audio/ogg; codecs=opus') || MediaSource.isTypeSupported('audio/webm; codecs=opus')));
        if(supportsMSE){
          const mime = MediaSource.isTypeSupported('audio/ogg; codecs=opus') ? 'audio/ogg; codecs=opus' : 'audio/webm; codecs=opus';
          const ms = new MediaSource();
          player.src = URL.createObjectURL(ms);
          await new Promise(resolve => ms.addEventListener('sourceopen', resolve, { once: true }));
          const sb = ms.addSourceBuffer(mime);
          const waitUpdateEnd = () => new Promise(r => sb.addEventListener('updateend', function h(){ sb.removeEventListener('updateend', h); r(); }, { once: true }));
          let started=false;
          while(true){
            if(currentReqId !== reqId) { try{ if(!ms.readyState.includes('ended')) ms.endOfStream(); }catch{} try{ player.pause(); }catch{} return; }
            const {done, value} = await reader.read(); if(done) break;
            if(first){ first=false; const msTTFB = Math.max(0, Math.round(performance.now()-ttsStartMs)); Telemetry.emit('tts_ttfb_ms', { ms: msTTFB }); }
            if(value && value.byteLength){
              if(sb.updating) await waitUpdateEnd();
              try{ sb.appendBuffer(value); }catch{ break; }
              if(!started){ started=true; try{ await player.play(); }catch{} }
            }
          }
          try{ if(sb.updating) await waitUpdateEnd(); ms.endOfStream(); }catch{}
        } else {
          // Fallback: буферизуем и проигрываем целиком
          const chunks=[];
          while(true){
            if(currentReqId !== reqId) return; // отменено бардж-ином
            const {done, value} = await reader.read(); if(done) break;
            if(first){ first=false; const ms2 = Math.max(0, Math.round(performance.now()-ttsStartMs)); Telemetry.emit('tts_ttfb_ms', { ms: ms2 }); }
            if(value) chunks.push(value);
          }
          if(currentReqId !== reqId) return;
          const blob = new Blob(chunks); player.src = URL.createObjectURL(blob); try{ await player.play(); }catch{}
        }
        currentReqId = null; showBarge(true); pushAssistant('Воспроизведён вопрос.');
      }

      async function stopTts(){
        if(!currentReqId) return; try{ await fetch(`/api/tts/stop/${encodeURIComponent(currentReqId)}`, { method:'POST' }); }finally{ currentReqId=null; try{ player.pause(); }catch{} }
      }

      // Controls
      btnPause.addEventListener('click', ()=>{ paused = !paused; btnPause.textContent = paused ? 'Продолжить' : 'Пауза'; });
      btnFinish.addEventListener('click', ()=>{ Telemetry.emit('interview_finished'); stop(); location.href = '/candidate.html#done'; });
      btnMute.addEventListener('click', ()=>{ muted = !muted; btnMute.textContent = muted? 'Unmute':'Mute'; });
      btnRepeat.addEventListener('click', speakQuestion);
      btnChat.addEventListener('click', goChat);

      btnChatSend?.addEventListener('click', async ()=>{
        try{
          const text = (chatInput.value||'').trim(); if(!text) return;
          pushCandidate(text, false); chatInput.value='';
          const r = await fetch(`/api/dialog/next`, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ last_answer: text, lang: currentSttLang }) });
          const d = await r.json();
          if(d && d.question){
            document.getElementById('competency').textContent = 'Тема: ' + (d.competency||'');
            document.getElementById('question').textContent = d.question;
            pushAssistant(d.question);
          }
        }catch{}
      });

      // Start on load
      start().catch(err=>{ alert('Microphone error: '+(err?.message||String(err))); });

      // Keyboard shortcuts: M/R/Space
      window.addEventListener('keydown', (e)=>{
        const tag = (e.target.tagName||'').toLowerCase(); if(tag==='input'||tag==='textarea'||tag==='select') return;
        if(e.key==='m' || e.key==='M'){ e.preventDefault(); btnMute.click(); }
        else if(e.key==='r' || e.key==='R'){ e.preventDefault(); btnRepeat.click(); }
        else if(e.code==='Space'){ e.preventDefault(); btnPause.click(); }
      });

      // Manual lang change
      langSel.addEventListener('change', ()=>{
        const val = langSel.value;
        if(val==='auto'){
          chosenLangMode='auto'; autoLangLocked=false; const uiDefault = (navigator.language||'ru').startsWith('ru')?'ru-RU':'en-US'; currentSttLang = uiDefault; setLangDetected(currentSttLang+' (auto)'); connectStt(currentSttLang);
        } else {
          chosenLangMode='fixed'; currentSttLang=val; autoLangLocked=true; setLangDetected(currentSttLang); connectStt(currentSttLang);
        }
      });
    </script>
  </body>
  </html>


